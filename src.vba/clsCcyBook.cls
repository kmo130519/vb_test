Option ExplicitnnnPublic tdate As DatenPublic base_ccy As StringnPublic ccy As StringnPublic book_src As StringnPublic spot_position As DoublenPublic spot_position_pl As DoublenPublic fwd_position As DoublenPublic basic_rate As DoublenPublic book_rate As DoublenPublic book_amt As DoublenPublic spot_eval_pl As DoublenPublic spot_trd_pl As DoublenPublic fwd_eval_pl As DoublenPublic fwd_trd_pl As DoublennPublic fund_code As StringnnPublic Sub update_evaluation(eval_rate As Double)nn    basic_rate = eval_raten    n    n    spot_eval_pl = spot_position_pl * (eval_rate - book_rate)nnnEnd Subnn'------------------------------------------------------------------------------n' Assumption: We cannot take negative fx position, meaning additional_position should be greater than or equal to - spot_positionn'------------------------------------------------------------------------------nPublic Sub update_spot_position(additional_position As Double, rate As Double, Optional update_pl_position As Boolean = True, Optional calc_trading_pl As Boolean = False)n        n    ' In case additional position. i.e. adding long position on long positionn        n    If additional_position * spot_position_pl >= 0 Or Not calc_trading_pl Thenn    n        spot_position = spot_position + additional_positionn        n        If update_pl_position Thenn            book_amt = book_amt + additional_position * raten            spot_position_pl = spot_position_pl + additional_positionn            n            If spot_position_pl <> 0 Thenn                book_rate = book_amt / spot_position_pln            Elsen                book_rate = 0n            End Ifn            n        End Ifn        n    Elsenn        spot_position = spot_position + additional_positionn        n        If update_pl_position Thenn'            spot_position_pl = spot_position_pl + additional_positionn'            book_amt = book_amt + additional_position * book_raten'n'            spot_trd_pl = spot_trd_pl + additional_position * (book_rate - rate)n'n        ' In case canceling deal.n            Dim position_to_cancel As Doublen            Dim new_position As Doublen            n            position_to_cancel = min(Abs(additional_position), Abs(spot_position_pl)) * Sgn(additional_position)n            new_position = additional_position - position_to_canceln            n            book_amt = book_amt + position_to_cancel * book_rate + new_position * raten            spot_position_pl = spot_position_pl + additional_positionn            n            spot_trd_pl = spot_trd_pl + position_to_cancel * (book_rate - rate)n        n        End Ifnn        n        n    End IfnnnEnd Sub