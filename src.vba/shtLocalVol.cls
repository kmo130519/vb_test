Option ExplicitnnPublic Sub btnReadLocalVol_Click()nn    '전역변수 설정n    Call SET_GLOBALnn    '위기상황분석 옵션n    Dim scenario_id As Stringn    If SCENARIO_ENABLE = False Thenn        scenario_id = "0"n    Elsen        scenario_id = shtMarket.Range("SCENARIO_ID").valuen    End Ifn    n    Dim oCmd As New adoDB.Commandn    Dim oRS As New adoDB.Recordsetn    Dim sql As Stringn    n    Dim adoCon As New adoDB.Connectionn    Call connectDB(adoCon, TNS_SERVICE_NAME, USER_ID, PASSWORD)n    n    Dim source As Stringn    source = shtLocalVol.Range("market_source").valuen    n    Dim vol_type As Stringn    vol_type = shtLocalVol.Range("vol_type").valuen    n    Dim market_date_str As Stringn    market_date_str = date2str(shtLocalVol.Range("market_date").value)n    n    Dim market_prevdate_str As Stringn    market_prevdate_str = date2str(shtLocalVol.Range("market_prevdate").value)n    n    Dim the_range As Rangen    Dim ua_code As Stringn    n    With Applicationn        .ScreenUpdating = Falsen        .StatusBar = Falsen        .DisplayStatusBar = Truen        .Calculation = xlCalculationManualn        .EnableEvents = Falsen    End Withn    n    Dim i As Integern    n    For i = 1 To NUM_UAnn        ua_code = get_ua_code(i)n        n        If get_ua_idx(ua_code) <> ua.KRD020021147 Then 'KOSPI200 레버리지는 KOSPI200 vol. surface 적용하므로 skipn        n            Set the_range = shtLocalVol.Range(ua_code & "_local_vol_surface")n            the_range.Range(Cells(1, 1), Cells(51, 104)).ClearContentsn            the_range.Offset(0, 105).Range(Cells(1, 1), Cells(51, 104)).ClearContentsn        n            If is_active_ua(ua_code) Thenn                n                Application.StatusBar = "Importing volatility data... " & ua_coden                n                'If Left(ua_code, 3) = "KR7" Then 'single stock은 flat vol. 적용n                If is_flatvol_ua(ua_code) = True Thenn                    'flat_voln                    Call fill_flat_vol(ua_code, the_range, market_date_str, source, scenario_id, adoCon)n                    Call fill_flat_vol(ua_code, the_range.Offset(0, 105), market_prevdate_str, source, "0", adoCon)n                Elsen                    'vol_surfacen                    Call fill_local_vol(ua_code, vol_type, the_range, market_date_str, source, scenario_id, adoCon)n                    Call fill_local_vol(ua_code, vol_type, the_range.Offset(0, 105), market_prevdate_str, source, "0", adoCon)n                End Ifn                n                With the_range.Cells(-1, 1).Interiorn                    .Pattern = xlSolidn                    .PatternColorIndex = xlAutomaticn                    .ThemeColor = xlThemeColorLight1n                    .TintAndShade = 0n                    .PatternTintAndShade = 0n                End Withn                n            Elsen            n                the_range.Cells(1, 1) = "미사용"n                With the_range.Cells(-1, 1).Interiorn                    .Pattern = xlSolidn                    .PatternColorIndex = xlAutomaticn                    .ThemeColor = xlThemeColorDark1n                    .TintAndShade = -0.499984740745262n                    .PatternTintAndShade = 0n                End Withn            n            End Ifn        n        End Ifn        n    Next in   n    Call disconnectDB(adoCon)n    n    With Applicationn        .ScreenUpdating = Truen        .StatusBar = Falsen        .DisplayStatusBar = Truen        .Calculation = xlCalculationAutomaticn        .EnableEvents = Truen    End Withn    n    Set the_range = Nothingn    n    Set oRS = Nothingn    Set oCmd = Nothingn    Set adoCon = NothingnnEnd SubnnPrivate Sub fill_local_vol(ul_code As String, vol_type As String, the_range As Range, tdate As String, source As String, scenario_id As String, oDB As adoDB.Connection)nn    Dim oCmd As New adoDB.Commandn    Dim oRS As New adoDB.Recordsetn    Dim sql As Stringn    n    Dim bind_variable() As Stringn    Dim bind_value() As Variantn    ReDim bind_variable(2) As Stringn    ReDim bind_value(2) As Variantn    bind_variable(1) = ":tdate"n    bind_variable(2) = ":ul_code"n    bind_value(1) = tdaten    bind_value(2) = ul_codenn    If SCENARIO_ENABLE = True Thenn        ReDim Preserve bind_variable(3) As Stringn        ReDim Preserve bind_value(3) As Variantn        bind_variable(3) = ":scenarioid"n        bind_value(3) = scenario_idn    End Ifn    n    Dim size_t As Integern    Dim size_k As Integern    n    Call get_surface_size(size_t, size_k, ul_code, vol_type, tdate, source, oDB)n    n    Select Case vol_typen    Case "Implied"n        If source = "FRONT" Thenn            sql = getSQL(SQL_PATH_IV_SURFACE_FRONT, bind_variable, bind_value)n        Elsen            sql = getSQL(SQL_PATH_IV_SURFACE, bind_variable, bind_value)n        End Ifn    Case "Local"n        If source = "FRONT" Thenn            If SCENARIO_ENABLE Thenn                sql = getSQL(SQL_PATH_LV_SURFACE_ST, bind_variable, bind_value)n            Elsen                sql = getSQL(SQL_PATH_LV_SURFACE_FRONT, bind_variable, bind_value)n            End Ifn        Elsen            If SCENARIO_ENABLE Thenn                sql = getSQL(SQL_PATH_LV_SURFACE_ST, bind_variable, bind_value)n            Elsen                sql = getSQL(SQL_PATH_LV_SURFACE, bind_variable, bind_value)n            End Ifn        End Ifn    End Selectnn    With oCmdn        .ActiveConnection = oDBn        .CommandType = adCmdTextn        .CommandText = sqlnn        oRS.Open .Executen    End Withnn    Dim i, j As Integern    i = 2n    j = 2n    n    the_range.Cells(1, 1) = str2date(tdate)n    n    Do Until oRS.EOFn    n        the_range.Cells(1, j) = oRS(2) 'striken        the_range.Cells(i, 1) = str2date(oRS(3)) 'maturityn        the_range.Cells(i, j) = oRS(4) 'volnn        i = i + 1n        If (i = size_t + 2) Thenn            i = 2n            j = j + 1n        End Ifn        oRS.MoveNextn    Loopnn    oRS.Closen    n    Set oRS = Nothingn    Set oCmd = NothingnnEnd SubnnPrivate Sub fill_flat_vol(ul_code As String, the_range As Range, tdate As String, source As String, scenario_id As String, oDB As adoDB.Connection)nn    Dim oCmd As New adoDB.Commandn    Dim oRS As New adoDB.Recordsetn    Dim sql As Stringn    n    Dim bind_variable() As Stringn    Dim bind_value() As Variantn    ReDim bind_variable(2) As Stringn    ReDim bind_value(2) As Variantn    bind_variable(1) = ":tdate"n    bind_variable(2) = ":code"n    bind_value(1) = tdaten    bind_value(2) = ul_codenn    If SCENARIO_ENABLE = True Thenn        ReDim Preserve bind_variable(3) As Stringn        ReDim Preserve bind_value(3) As Variantn        bind_variable(3) = ":scenarioid"n        bind_value(3) = scenario_idn    End Ifn    n    sql = getSQL(SQL_PATH_FLAT_VOL, bind_variable, bind_value)nn    With oCmdn        .ActiveConnection = oDBn        .CommandType = adCmdTextn        .CommandText = sqlnn        oRS.Open .Executen    End Withnn    Dim num_dates As Integern    Dim num_strikes As Integern    num_dates = 36 '3yn    num_strikes = 101 'every 0.2%n    n    Dim s0 As Doublen    s0 = get_spot_price(ul_code, tdate, scenario_id, oDB)n    n    Dim i, j As Integern    n    the_range.Cells(1, 1) = str2date(tdate)n    n    Do Until oRS.EOFnn        For i = 1 To num_datesn            the_range.Cells(i + 1, 1) = DateAdd("m", i - 1, str2date(tdate) + 1)nn            For j = 1 To num_strikesn                If i = 1 Thenn                    the_range.Cells(1, j + 1) = s0 * (1 + 0.002 * (j - 51))n                End Ifn                the_range.Cells(i + 1, j + 1) = oRS(0)n            Next jn        Next inn        oRS.MoveNextn    Loopnn    oRS.Closen    n    Set oRS = Nothingn    Set oCmd = Nothingn    nEnd Subn